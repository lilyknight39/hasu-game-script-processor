# Dify 召回测试问题集

本文档包含用于测试和优化 TopK 和 Score 阈值的问题集。问题按类型分组，每组问题测试不同的召回场景。

## 测试说明

### TopK 测试建议
- **初始值**: 5-10
- **测试范围**: 3, 5, 10, 15, 20
- **评估标准**: 结果数量 vs 相关性平衡

### Score 阈值测试建议
- **初始值**: 0.7
- **测试范围**: 0.5, 0.6, 0.7, 0.8, 0.9
- **评估标准**: 召回率 vs 准确率平衡

---

## 一、角色关系查询（测试人物关联召回）

### 1.1 单一角色查询
1. 藤島慈是谁？她的性格特点是什么？
2. 夕霧綴理有什么特别之处？
3. 乙宗梢在故事中是什么角色？
4. 大賀美沙知和其他角色的关系如何？

### 1.2 角色互动查询
5. 慈和梢之间发生了什么？她们的关系如何？
6. 綴理和慈是怎么认识的？
7. 梢对綴理的态度有什么变化？
8. 三个一年级生（慈、梢、綴理）之间的关系如何发展？

**预期召回**: 应该返回包含角色对话、互动场景的chunk
**优化目标**: TopK=5-7 时应包含主要互动场景

---

## 二、情节事件查询（测试事件召回）

### 2.1 具体事件
9. 撫子祭是什么？发生了什么？
10. 梢创作了什么曲子？
11. 綴理负责的振り付け（编舞）遇到了什么问题？
12. 慈提出了什么解决方案来应对沙知前辈的困境？
13. 三人的制服衣装有什么特殊意义？

### 2.2 情节转折
14. 为什么练习过程中气氛变得很糟糕？
15. 慈和梢发生了什么冲突？
16. 梢的内心挣扎是什么？
17. 最后三人是如何和解的？

**预期召回**: 应该返回包含事件描述、情节发展的chunk
**优化目标**: TopK=7-10，Score≥0.7 时应包含完整事件链

---

## 三、场景地点查询（测试元数据召回）

### 3.1 场所查询
18. レッスンルーム（练习室）里发生了什么？
19. 在部室（部室）发生的重要对话有哪些？
20. 中庭的场景描述
21. 音楽堂（音乐堂）的场景

### 3.2 时间查询
22. 午後（下午）的场景
23. 夜晚发生了什么重要的事情？
24. 早晨的日常描写

**预期召回**: 测试keywords字段中的场所和时间信息是否有效
**优化目标**: 应优先召回匹配场所/时间的chunk

---

## 四、情感主题查询（测试语义理解）

### 4.1 情感类
25. 描写友情的场景
26. 有哪些感人的瞬间？
27. 角色感到焦虑或压力的情节
28. 展现成长和突破的片段

### 4.2 主题类
29. 关于梦想和目标的对话
30. 关于团队合作的内容
31. 克服困难的故事
32. スクールアイドル（校园偶像）的意义

**预期召回**: 测试语义相似度而非关键词匹配
**优化目标**: Score阈值应较低(0.6-0.7)以捕获语义相似内容

---

## 五、具体对话查询（测试精确匹配）

### 5.1 经典台词
33. "世界中を夢中にしよう" 这句话是谁说的？在什么情境下？
34. 谁说过 "私たちなら、きっと"？
35. "On your mark" 是什么时候出现的？
36. 关于 "無敵" 的对话

### 5.2 对话内容
37. 慈对梢说了什么让她哭了？
38. 綴理在中庭和慈说了什么？
39. 沙知前辈给慈的建议是什么？
40. 三人最后一起喊的口号是什么？

**预期召回**: 应该精确返回包含对话的chunk
**优化目标**: TopK=3-5，Score≥0.8 时应精确匹配

---

## 六、复杂组合查询（测试综合召回能力）

### 6.1 多条件组合
41. 撫子祭准备期间，三人在练习室遇到的困难和解决过程
42. 梢从最初对綴理的态度，到后来关系改善的过程
43. 慈的配信（直播）活动和沙知前辈的建议
44. 振り付け修改的讨论过程和最终决定

### 6.2 跨场景查询
45. 从部室到练习室再到舞台，三人的准备历程
46. 早晨叫綴理起床的日常到撫子祭舞台的发展
47. 沙知前辈在整个故事中的作用和影响
48. 102期生的成长轨迹

**预期召回**: 测试是否能召回相关但不同场景的内容
**优化目标**: TopK=10-15，Score=0.65-0.75 以平衡覆盖度

---

## 七、边缘案例测试（测试召回边界）

### 7.1 模糊查询
49. 三个女孩的故事
50. 学校活动的准备
51. 音乐和舞蹈
52. 青春成长

### 7.2 细节查询
53. BGM 是什么？
54. 场景编号的含义
55. 具体的台詞数（对话数量）
56. ココア（可可）出现在什么场景？

**预期召回**: 测试过于宽泛或过于细节的查询效果
**优化目标**: 宽泛查询提高TopK，细节查询提高Score阈值

---

## 八、否定和对比查询（测试理解能力）

### 8.1 否定查询
57. 哪些场景没有沙知前辈参与？
58. 慈在什么情况下没有表现出自信？
59. 不涉及练习的日常场景

### 8.2 对比查询
60. 慈和梢的性格有什么不同？
61. 綴理在故事开始和结束时的变化
62. 白天和夜晚场景的氛围差异

**预期召回**: 测试对否定和对比的理解（较难）
**优化目标**: 可能需要更高TopK(15-20)和较低Score(0.6)

---

## 测试流程建议

### 阶段一：基准测试
1. 使用默认参数 (TopK=10, Score=0.7)
2. 逐一测试所有60+问题
3. 记录每个问题的召回结果数量和前3个结果的相关性

### 阶段二：TopK 优化
1. 固定 Score=0.7
2. 对每类问题测试不同TopK值 (3, 5, 10, 15, 20)
3. 找出每类问题的最佳TopK范围

### 阶段三：Score 阈值优化
1. 使用阶段二找到的最佳TopK
2. 测试不同Score阈值 (0.5, 0.6, 0.7, 0.8, 0.9)
3. 平衡召回率和准确率

### 阶段四：综合优化
1. 根据应用场景确定优先级（召回率 vs 准确率）
2. 为不同查询类型设置不同参数组合
3. 建立查询路由策略

---

## 评估指标

### 定性评估
- **完全相关**: 结果直接回答问题
- **部分相关**: 结果包含相关信息但不完整
- **不相关**: 结果与问题无关

### 定量指标
```
召回率 = 返回的相关结果数 / 实际相关的总chunk数
准确率 = 返回的相关结果数 / 返回的总结果数
F1分数 = 2 * (准确率 * 召回率) / (准确率 + 召回率)
```

### 推荐参数组合

| 查询类型 | TopK | Score阈值 | 说明 |
|---------|------|----------|------|
| 精确对话 | 3-5 | 0.80+ | 高精度要求 |
| 角色关系 | 5-7 | 0.70-0.75 | 平衡召回和精度 |
| 情节事件 | 7-10 | 0.70 | 需要上下文 |
| 情感主题 | 10-15 | 0.65-0.70 | 语义理解为主 |
| 复杂查询 | 10-15 | 0.65-0.75 | 多方面信息 |
| 模糊查询 | 15-20 | 0.60-0.65 | 广泛探索 |

---

## 使用建议

1. **优先测试第一、二、五类问题**：这些问题有明确的答案，容易评估召回效果
2. **使用第四、六类问题优化语义理解**：调整embedding模型或Score阈值
3. **第七、八类问题用于压力测试**：了解系统边界和局限性
4. **建立测试集标准答案**：手动标注每个问题应召回哪些chunk作为ground truth
5. **持续迭代**：随着数据增长和用户反馈，不断调整参数

---

## 附录：快速测试命令示例

```bash
# 使用 Dify API 测试（示例）
curl -X POST 'https://your-dify-instance/v1/chat-messages' \
  -H 'Authorization: Bearer {api-key}' \
  -H 'Content-Type: application/json' \
  -d '{
    "query": "藤島慈是谁？",
    "user": "test-user",
    "retrieval_model": {
      "top_k": 10,
      "score_threshold": 0.7
    }
  }'
```
